services:
  comfyui-gpu0:
    image: mmartial/comfyui-nvidia-docker:ubuntu22_cuda12.2-20260121
    container_name: comfyui-gpu0
    restart: unless-stopped
    environment:
      USE_UV: "true"
      WANTED_UID: "${WANTED_UID:-1000}"
      WANTED_GID: "${WANTED_GID:-1000}"
      BASE_DIRECTORY: /comfy/mnt
      SECURITY_LEVEL: normal
      NVIDIA_VISIBLE_DEVICES: "0"
      COMFY_CMDLINE_EXTRA: "--listen 0.0.0.0 --port 8188"
    volumes:
      - ./:/comfy/mnt
    ports:
      - "19163:8188"
    expose:
      - "8188"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ["0"]
              capabilities: [gpu]
    networks:
      - comfy-net

  fastapi-router:
    build:
      context: ./fastapi
    container_name: comfy-fastapi-router
    restart: unless-stopped
    environment:
      COMFYUI_WORKERS: "comfyui-gpu0:8188"
      COMFY_REQUEST_TIMEOUT_SECONDS: "3600"
      OUTPUT_DIR: "/data/outputs"
    ports:
      - "19164:19164"
    depends_on:
      comfyui-gpu0:
        condition: service_started
    networks:
      - comfy-net

networks:
  comfy-net:
    name: comfy-net
