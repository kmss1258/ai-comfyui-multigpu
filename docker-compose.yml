services:
  init-volumes:
    image: alpine:3.20
    container_name: comfy-init-volumes
    user: "0:0"
    command: >-
      sh -lc "
      mkdir -p
      /workspace/run
      /workspace/basedir
      /workspace/router_data/outputs
      && chown -R ${WANTED_UID:-1000}:${WANTED_GID:-1000} /workspace/run /workspace/basedir /workspace/router_data
      "
    volumes:
      - ./:/workspace
    restart: "no"

  comfyui-gpu0:
    image: mmartial/comfyui-nvidia-docker:ubuntu22_cuda12.2-20260121
    container_name: comfyui-gpu0
    restart: unless-stopped
    environment:
      USE_UV: "true"
      WANTED_UID: "${WANTED_UID:-1000}"
      WANTED_GID: "${WANTED_GID:-1000}"
      BASE_DIRECTORY: /basedir
      SECURITY_LEVEL: normal
      NVIDIA_VISIBLE_DEVICES: "0"
      COMFY_CMDLINE_EXTRA: "--listen 0.0.0.0 --port 8188"
    volumes:
      - ./run:/comfy/mnt
      - ./basedir:/basedir
    ports:
      - "19165:8188"
    expose:
      - "8188"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ["0"]
              capabilities: [gpu]
    depends_on:
      init-volumes:
        condition: service_completed_successfully
    networks:
      - comfy-net

  # comfyui-gpu1:
  #   image: mmartial/comfyui-nvidia-docker:ubuntu22_cuda12.2-20260121
  #   container_name: comfyui-gpu1
  #   restart: unless-stopped
  #   environment:
  #     USE_UV: "true"
  #     WANTED_UID: "${WANTED_UID:-1000}"
  #     WANTED_GID: "${WANTED_GID:-1000}"
  #     BASE_DIRECTORY: /basedir
  #     SECURITY_LEVEL: normal
  #     NVIDIA_VISIBLE_DEVICES: "1"
  #     COMFY_CMDLINE_EXTRA: "--listen 0.0.0.0 --port 8188"
  #   volumes:
  #     - ./run-gpu1:/comfy/mnt
  #     - ./basedir:/basedir
  #   expose:
  #     - "8188"
  #   deploy:
  #     resources:
  #       reservations:
  #         devices:
  #           - driver: nvidia
  #             device_ids: ["1"]
  #             capabilities: [gpu]
  #   depends_on:
  #     init-volumes:
  #       condition: service_completed_successfully
  #   networks:
  #     - comfy-net

  comfyui-gpu2:
    image: mmartial/comfyui-nvidia-docker:ubuntu22_cuda12.2-20260121
    container_name: comfyui-gpu2
    restart: unless-stopped
    environment:
      USE_UV: "true"
      WANTED_UID: "${WANTED_UID:-1000}"
      WANTED_GID: "${WANTED_GID:-1000}"
      BASE_DIRECTORY: /basedir
      SECURITY_LEVEL: normal
      NVIDIA_VISIBLE_DEVICES: "2"
      COMFY_CMDLINE_EXTRA: "--listen 0.0.0.0 --port 8188"
    volumes:
      - ./run:/comfy/mnt
      - ./basedir:/basedir
    expose:
      - "8188"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ["2"]
              capabilities: [gpu]
    depends_on:
      init-volumes:
        condition: service_completed_successfully
    networks:
      - comfy-net

  comfyui-gpu3:
    image: mmartial/comfyui-nvidia-docker:ubuntu22_cuda12.2-20260121
    container_name: comfyui-gpu3
    restart: unless-stopped
    environment:
      USE_UV: "true"
      WANTED_UID: "${WANTED_UID:-1000}"
      WANTED_GID: "${WANTED_GID:-1000}"
      BASE_DIRECTORY: /basedir
      SECURITY_LEVEL: normal
      NVIDIA_VISIBLE_DEVICES: "3"
      COMFY_CMDLINE_EXTRA: "--listen 0.0.0.0 --port 8188"
    volumes:
      - ./run:/comfy/mnt
      - ./basedir:/basedir
    expose:
      - "8188"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ["3"]
              capabilities: [gpu]
    depends_on:
      init-volumes:
        condition: service_completed_successfully
    networks:
      - comfy-net

  super-resolve:
    build:
      context: ./sr-service
    container_name: comfy-super-resolve
    restart: unless-stopped
    expose:
      - "8000"
    networks:
      - comfy-net

  fastapi-router:
    build:
      context: ./fastapi
    container_name: comfy-fastapi-router
    restart: unless-stopped
    environment:
      COMFYUI_WORKERS: "comfyui-gpu0:8188,comfyui-gpu2:8188,comfyui-gpu3:8188"
      COMFY_REQUEST_TIMEOUT_SECONDS: "3600"
      PROMPT_CONCURRENCY_PER_WORKER: "1"
      SUPER_RESOLVE_BASE_URL: "${SUPER_RESOLVE_BASE_URL:-http://super-resolve:8000}"
      SUPER_RESOLVE_PATH: "${SUPER_RESOLVE_PATH:-/v1/audio/super-resolve}"
      OUTPUT_DIR: "/data/outputs"
    ports:
      - "19164:19164"
    volumes:
      - ./router_data:/data
    depends_on:
      comfyui-gpu0:
        condition: service_started
      comfyui-gpu2:
        condition: service_started
      comfyui-gpu3:
        condition: service_started
      super-resolve:
        condition: service_started
    networks:
      - comfy-net

networks:
  comfy-net:
    name: comfy-net
